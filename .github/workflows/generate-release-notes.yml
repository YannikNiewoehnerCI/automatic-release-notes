name: generate-release-notes

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: read

jobs:
  release_notes:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Determine previous tag
        id: prev
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"

          PREV_TAG="$(git tag --sort=-creatordate \
            | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' \
            | grep -v "^${TAG}$" \
            | head -n 1 || true)"

          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "prev_tag=${PREV_TAG}" >> "$GITHUB_OUTPUT"

          echo "Current tag: ${TAG}"
          echo "Previous tag: ${PREV_TAG:-<none>}"

      - name: Generate release notes via GitHub (PR-based)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          TAG="${{ steps.prev.outputs.tag }}"
          PREV="${{ steps.prev.outputs.prev_tag }}"

          if [ -n "$PREV" ]; then
            gh api -X POST "repos/${GITHUB_REPOSITORY}/releases/generate-notes" \
              -f tag_name="$TAG" \
              -f previous_tag_name="$PREV" \
              --jq '.body' > RELEASE_NOTES.md
          else
            # Falls es noch keinen vorherigen Tag gibt
            gh api -X POST "repos/${GITHUB_REPOSITORY}/releases/generate-notes" \
              -f tag_name="$TAG" \
              --jq '.body' > RELEASE_NOTES.md
          fi

          echo "## ${TAG} - $(date +%F)" | cat - RELEASE_NOTES.md > tmp && mv tmp RELEASE_NOTES.md
          echo "Generated RELEASE_NOTES.md"
          sed -n '1,120p' RELEASE_NOTES.md

      - name: Create draft GitHub release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          TAG="${{ steps.prev.outputs.tag }}"
          gh release create "$TAG" \
            --draft \
            --title "$TAG" \
            --notes-file RELEASE_NOTES.md

      - name: Upload release notes artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: RELEASE_NOTES.md
